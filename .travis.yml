language: node_js

os: linux

dist: xenial

branches:
  except:
    - docs

cache:
  npm: true
  directories:
    - ~/.cache

stages:
  - unit test
  - integration test
  - name: acceptance test
    if: branch IN (master, dev)
  - name: staging build
    if: (
      branch = dev
      AND
      type = push
      )
  - name: deploy
    if: (
      branch = master
      AND
      type = push
      )

jobs:
  include:
    # For base alias
    - &node_12_backend_base
      stage: unit test
      node_js: 12
      os: linux
      install:
        - cd backend;
          npm install;
      env:
        - secure: "jTkfY40vQnnT01n5qrQykEjH5Iyqjik3ucVKDypVVUnJO0u+B8ChfM5wfpAcoerzP7SLUGUM0lVJwTjKUE1zxR3vA/62CCJVAp+F/YoiHvEhBHJ0WTriY+Bo//Pw4RtfKerWj4kMWl9EQF12zQdsMq2XbNDV8rLmRw6trgeTzRANHFevFGvaoYcKgP4AENDZciVGH70eWzEyBqRqu4WmOQ69OQQSbgUu6wHcvMAwQEizPg6vw9SGWoHXPgXYsymWf/G0VtogY3K/iuaou9RISlAI3MlcgdsJ4pzHWGDAyclxRTEsdg/1nkFqgpp2lzrUTkdh6yhwsEKsCdueAldQRo/SOodqydjISWuW0CDX60i2+te4urrV283veJxiOlMe6tledvOihMU+NEqyz8ORPXmKf7dkruoCwLEjqBowHGKkqsPCECpuvghb4mgs/FEtNiOOsBTeXv3quo8pBqySyiEWOG2sT9apsdf9mC7xxTM62bTIS/zpFKsszGnjfhJOu3aqiPq75ZZaYbb3T4fu8IJnCee7MeG8+IwDdKh7lNQ/iqRoP6Vp3KWWXb2jwERRgCb393Kwpfkj27IbOM6dy5ToiY3uYMPaluZIsUEWHuvlF+6W32Iq3RyfJsuIH94du2EOQdEfQPuQtdCy7BwqCuo2ToXLtEOjqDOfTwCqWLs="
        - NODE_ENV=UNIT_TEST
      script:
        - npm run unit

    # Int test
    - <<: *node_12_backend_base
      stage: integration test
      env:
        - secure: "jTkfY40vQnnT01n5qrQykEjH5Iyqjik3ucVKDypVVUnJO0u+B8ChfM5wfpAcoerzP7SLUGUM0lVJwTjKUE1zxR3vA/62CCJVAp+F/YoiHvEhBHJ0WTriY+Bo//Pw4RtfKerWj4kMWl9EQF12zQdsMq2XbNDV8rLmRw6trgeTzRANHFevFGvaoYcKgP4AENDZciVGH70eWzEyBqRqu4WmOQ69OQQSbgUu6wHcvMAwQEizPg6vw9SGWoHXPgXYsymWf/G0VtogY3K/iuaou9RISlAI3MlcgdsJ4pzHWGDAyclxRTEsdg/1nkFqgpp2lzrUTkdh6yhwsEKsCdueAldQRo/SOodqydjISWuW0CDX60i2+te4urrV283veJxiOlMe6tledvOihMU+NEqyz8ORPXmKf7dkruoCwLEjqBowHGKkqsPCECpuvghb4mgs/FEtNiOOsBTeXv3quo8pBqySyiEWOG2sT9apsdf9mC7xxTM62bTIS/zpFKsszGnjfhJOu3aqiPq75ZZaYbb3T4fu8IJnCee7MeG8+IwDdKh7lNQ/iqRoP6Vp3KWWXb2jwERRgCb393Kwpfkj27IbOM6dy5ToiY3uYMPaluZIsUEWHuvlF+6W32Iq3RyfJsuIH94du2EOQdEfQPuQtdCy7BwqCuo2ToXLtEOjqDOfTwCqWLs="
        - NODE_ENV=INT_TEST
      script:
        - npm run int
    
    - &node_12_frontend_base
      stage: integration test
      node_js: 12
      os: linux
      install:
        - cd frontend;
          npm install
      before_script:
        - npx http-server files -c-1 &
      script:
        - npm run cy_int_test

    # Acceptance test
    - stage: acceptance test
      node_js: 12
      os: linux
      env:
        - secure: "iO3rM6KNRoKT9uEG//ck1qCP9qh+R0aCsJVH5I9GGagy8JQr2oBFmbnYAtZ/CD2F+ez23hm1erXe0m6FhyY6Us4sMM6w5GinfwYlpsUck+LGydUq67mhA+wZQdCY+T3ULUENrkfZMoSEq/z3oSw2mafbrBr9JNVn2M0ghCfEK9c9ZrlTbXEIwj77KIdU9i1rdxrWwZF9wY0rLt40noUyl/d2XJyXlo8mN6yAAMz5aYhcuLL2OPhNtVueP4hoWXlPLpixy89xBMc/U6+Jxw5PbOwviyWt/VbVtw3r1pUTi+0KLdIUpfhcZgQMvikQnPSGZDCg6KFvkwMurPy/jbb4sU2LhAm1gwr5XVjXyWm2axPHtyuUvN/vw/gFV4qVp1z4zgHO5N/q4A9zzwQ/MOtA2dshltW5atOq/giQ/UZvRJyYlih+KP4qQQUZ1FjIq5DoLH6P3gcAY2zqSWvmJiQ+pGqjVPaiGcDdzwMTY95YPlXmMHpYQr2pSWJ6LSGDFgGg75P4udQt8v3Pr2VF1OBcfdeXdX6jVz4MQukhzYEcpJzfPXEzjA/LTpfQHIajPGNT7QxtPAr5hmKoBla7VR4H6VY3rbjenWOIRyzbrzENpJcjB/jRPtvOkKDprtg8xkdOwrPtdhpKcpdv2YvLejcw2cms8hPNLgdvVScvbimgVgg="
        - NODE_ENV=ACC_TEST
      install:
        - cd backend;
          npm install;
          cd ..;
          cd frontend;
          npm install;
      before_script:
        - sed -i -e 's/false/true/' files/configs.js;
        - npx http-server files -c-1 &
        - cd ..; cd backend; npm start &
        - cd ..; cd frontend
      script:
        - npm run cy_acc_test
    
    # Staging
    - stage: staging build
      script: skip
      before_deploy: cd backend
      deploy:
        provider: heroku
        api_key:
          secure: BvFNCRmAqj4+hs4Lc4/U3GBbeBr7Qore4jv3lUCoIG4dUSEYcf13XTkub1FV/r1oYRQOemxCJpARsn+1bDywc9zcHRux+1AQaLC26DGfdhdsRzKU/W85mLyXrBJSWkGiIjMHdh9U3KcD35duKJpXezVn6j8sshgRJ5OljGRxeIbyzn6/Kmx6RP7eVR/1hOZ2CgXD/oFnyTGa16yzPgIR2E70ebZCHhuIM8JXFRaUkBTLFEScpdWpqRNCfZ8k2ltICgfcwP6RZiu/Nk2MnMj92AQpNw1WpBi8qqpihIgMMbLhU0Yq6z1W90eW/WZ+7Tnu7D6erh8Xhvknb0lfsQq+QCTizyVEMTRxYNDjp5Uu8ag7OvZvGfcN7NvqkvFUPGlbm6TOngOJBVOHNwUoa/BY+Hz9tDAFIhWthaIA1vg/vhapbWP3Kdysr2aAcbyNj5If6Kd9NXxHCo6pr/uV+IjB7jdk6oJ2i8KOez54gpW/jzjiRiQRzburlMmOon5SkFf1STtAXHhCnzipBnpXcLX+vCcvfJcfVQg8ETyKu15eifqBxE5DYHKPIQzTlcceiMSIBG9C7jQXf0fwg+Hbz5drTU8RZTDTQVN9UbdWmOEGUyJ10cowzXUAFo8YrIYOv6byKhBPKHEni7Q1StPl3ZiG/QOxWafsLwlgokC0NJhWJbU=
        app: fsp-staging
        on: dev

    # Deployment stage
    - stage: deploy
      script: skip
      before_deploy: cd backend
      deploy:
        provider: heroku
        api_key:
          secure: BvFNCRmAqj4+hs4Lc4/U3GBbeBr7Qore4jv3lUCoIG4dUSEYcf13XTkub1FV/r1oYRQOemxCJpARsn+1bDywc9zcHRux+1AQaLC26DGfdhdsRzKU/W85mLyXrBJSWkGiIjMHdh9U3KcD35duKJpXezVn6j8sshgRJ5OljGRxeIbyzn6/Kmx6RP7eVR/1hOZ2CgXD/oFnyTGa16yzPgIR2E70ebZCHhuIM8JXFRaUkBTLFEScpdWpqRNCfZ8k2ltICgfcwP6RZiu/Nk2MnMj92AQpNw1WpBi8qqpihIgMMbLhU0Yq6z1W90eW/WZ+7Tnu7D6erh8Xhvknb0lfsQq+QCTizyVEMTRxYNDjp5Uu8ag7OvZvGfcN7NvqkvFUPGlbm6TOngOJBVOHNwUoa/BY+Hz9tDAFIhWthaIA1vg/vhapbWP3Kdysr2aAcbyNj5If6Kd9NXxHCo6pr/uV+IjB7jdk6oJ2i8KOez54gpW/jzjiRiQRzburlMmOon5SkFf1STtAXHhCnzipBnpXcLX+vCcvfJcfVQg8ETyKu15eifqBxE5DYHKPIQzTlcceiMSIBG9C7jQXf0fwg+Hbz5drTU8RZTDTQVN9UbdWmOEGUyJ10cowzXUAFo8YrIYOv6byKhBPKHEni7Q1StPl3ZiG/QOxWafsLwlgokC0NJhWJbU=
        app: fsp-deploy
        on: master

    - stage: deploy
      script: skip
      deploy:
        provider: pages
        skip_cleanup: true
        github_token:
          - secure: "p0IRmBu3CuYmlOfR8+gVKeSG8aAWzYoIUlJO5p6Dsjdhes2xN+ScKgc72RKFOh7VxLzv5t5Y+rs6+8vZzWU49WQ7j/F/uC16pqjosFKZFj5bM1sxQNKKhAtpAbo9gHHYRAibHwL4HjM1xfD+5nqXG45hbkdrX/H5SPlnGHoEXxjyfw1+x16qP+Xq+KiKltEyfkLa6xmo0MEiYG+KS8SMwMUVAOT+2LhT/D2ZIQRu68REJ2gEqTIdI/XmOlqddp9DfkEM6X/zNFvbrKB283cLJe/H8Ijf60r3QRaPvM+/XsGJx3L34DUAMmXma+PKkPGm81rcDfasho/g9nKCWXkIIYu48pKaJWfBkjwDQcT3NGflWHE7bCtIZr8VygHMOtwxAyLPsibrkvL2ttNusrm3xHu2CGqRtkELJxAKUATv1pPgmQHAxl5z1lK9UhkILfgUG7FibkU5mgSCtMY43DkMQQMNLKrb0gXVZmz5dvNzSly7fOJ6r5I3nfD04fuNshuNNZS3oj0tsx7RNFmr5TN+yQF+qjeEBotD7pWFI2dfgd0tbH6Ek/jAV/AmRISXsF/wJueKFCGgXe/4qBUA3gllDzkSS6b69duuEs7ONLM5jBi/MvShJqLuU8FiU1fmvZHZNDbhLvelHhE/hb0i751ih/tr81j7IJ3LlRDml1WKr4k="
        keep_history: true
        local_dir: frontend/files
        target_branch: gh-pages
        on:
          branch: master